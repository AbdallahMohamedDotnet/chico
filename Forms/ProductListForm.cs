using ChicoDesktopApp.Models;
using ChicoDesktopApp.Repositories;
using System;
using System.Drawing;
using System.Linq;
using System.Windows.Forms;

namespace ChicoDesktopApp.Forms
{
    public partial class ProductListForm : Form
    {
        private readonly ProductRepository _productRepository;
        private readonly CategoryRepository _categoryRepository;
        private readonly DatabaseHelper _dbHelper;
        
        private DataGridView dgvProducts = null!;
        private TextBox txtSearch = null!;
        private ComboBox cmbCategory = null!;
        private CheckBox chkLowStock = null!;
        private Button btnSearch = null!;
        private Button btnAdd = null!;
        private Button btnEdit = null!;
        private Button btnDelete = null!;
        private Button btnRefresh = null!;
        private Label lblTotalProducts = null!;
        private Label lblLowStock = null!;

        public ProductListForm()
        {
            _dbHelper = new DatabaseHelper();
            _productRepository = new ProductRepository(_dbHelper);
            _categoryRepository = new CategoryRepository(_dbHelper);
            
            InitializeComponent();
            SetupForm();
            LoadCategories();
            LoadProducts();
        }

        private void InitializeComponent()
        {
            this.SuspendLayout();
            
            // Form properties
            this.Text = "ÿ•ÿØÿßÿ±ÿ© ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ - Chico ERP";
            this.WindowState = FormWindowState.Maximized;
            this.StartPosition = FormStartPosition.CenterScreen;
            this.RightToLeft = RightToLeft.Yes;
            this.RightToLeftLayout = true;
            this.Font = new Font("Segoe UI", 10F);
            this.MinimumSize = new Size(1024, 768);

            // Search Panel
            var pnlSearch = new Panel
            {
                Dock = DockStyle.Top,
                Height = 80,
                Padding = new Padding(10),
                BackColor = Color.FromArgb(240, 240, 240)
            };

            // Search TextBox
            txtSearch = new TextBox
            {
                Location = new Point(850, 15),
                Size = new Size(250, 30),
                Font = new Font("Segoe UI", 11F),
                PlaceholderText = "ÿ®ÿ≠ÿ´ ÿ®ÿßŸÑÿßÿ≥ŸÖ ÿ£Ÿà ÿßŸÑÿ®ÿßÿ±ŸÉŸàÿØ..."
            };
            txtSearch.TextChanged += (s, e) => LoadProducts();

            // Category Filter
            cmbCategory = new ComboBox
            {
                Location = new Point(600, 15),
                Size = new Size(200, 30),
                DropDownStyle = ComboBoxStyle.DropDownList,
                Font = new Font("Segoe UI", 10F)
            };
            cmbCategory.SelectedIndexChanged += (s, e) => LoadProducts();

            // Low Stock Checkbox
            chkLowStock = new CheckBox
            {
                Location = new Point(430, 18),
                Size = new Size(150, 25),
                Text = "ŸÖŸÜÿ™ÿ¨ÿßÿ™ ŸÇŸÑŸäŸÑÿ© ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ",
                Font = new Font("Segoe UI", 10F)
            };
            chkLowStock.CheckedChanged += (s, e) => LoadProducts();

            // Search Button
            btnSearch = new Button
            {
                Location = new Point(320, 15),
                Size = new Size(100, 35),
                Text = "ÿ®ÿ≠ÿ´",
                BackColor = Color.FromArgb(52, 152, 219),
                ForeColor = Color.White,
                FlatStyle = FlatStyle.Flat,
                Font = new Font("Segoe UI", 11F, FontStyle.Bold)
            };
            btnSearch.FlatAppearance.BorderSize = 0;
            btnSearch.Click += (s, e) => LoadProducts();

            // Refresh Button
            btnRefresh = new Button
            {
                Location = new Point(210, 15),
                Size = new Size(100, 35),
                Text = "ÿ™ÿ≠ÿØŸäÿ´",
                BackColor = Color.FromArgb(46, 204, 113),
                ForeColor = Color.White,
                FlatStyle = FlatStyle.Flat,
                Font = new Font("Segoe UI", 11F, FontStyle.Bold)
            };
            btnRefresh.FlatAppearance.BorderSize = 0;
            btnRefresh.Click += (s, e) => LoadProducts();

            // Stats Labels
            lblTotalProducts = new Label
            {
                Location = new Point(15, 50),
                Size = new Size(200, 25),
                Font = new Font("Segoe UI", 10F),
                Text = "ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™: 0"
            };

            lblLowStock = new Label
            {
                Location = new Point(220, 50),
                Size = new Size(200, 25),
                Font = new Font("Segoe UI", 10F),
                ForeColor = Color.Red,
                Text = "ŸÖŸÜÿ™ÿ¨ÿßÿ™ ŸÇŸÑŸäŸÑÿ© ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ: 0"
            };

            pnlSearch.Controls.AddRange(new Control[] {
                txtSearch, cmbCategory, chkLowStock, btnSearch, btnRefresh,
                lblTotalProducts, lblLowStock
            });

            // DataGridView
            dgvProducts = new DataGridView
            {
                Dock = DockStyle.Fill,
                AutoSizeColumnsMode = DataGridViewAutoSizeColumnsMode.Fill,
                SelectionMode = DataGridViewSelectionMode.FullRowSelect,
                MultiSelect = false,
                ReadOnly = true,
                AllowUserToAddRows = false,
                AllowUserToDeleteRows = false,
                BackgroundColor = Color.White,
                BorderStyle = BorderStyle.None,
                RowHeadersVisible = false,
                Font = new Font("Segoe UI", 10F),
                RowTemplate = { Height = 35 }
            };
            dgvProducts.CellDoubleClick += DgvProducts_CellDoubleClick;
            dgvProducts.CellFormatting += DgvProducts_CellFormatting;

            // Action Panel
            var pnlActions = new Panel
            {
                Dock = DockStyle.Bottom,
                Height = 70,
                Padding = new Padding(10),
                BackColor = Color.FromArgb(240, 240, 240)
            };

            // Add Button
            btnAdd = new Button
            {
                Location = new Point(880, 15),
                Size = new Size(120, 40),
                Text = "‚ûï ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸÜÿ™ÿ¨",
                BackColor = Color.FromArgb(46, 204, 113),
                ForeColor = Color.White,
                FlatStyle = FlatStyle.Flat,
                Font = new Font("Segoe UI", 12F, FontStyle.Bold)
            };
            btnAdd.FlatAppearance.BorderSize = 0;
            btnAdd.Click += BtnAdd_Click;

            // Edit Button
            btnEdit = new Button
            {
                Location = new Point(740, 15),
                Size = new Size(120, 40),
                Text = "‚úèÔ∏è ÿ™ÿπÿØŸäŸÑ",
                BackColor = Color.FromArgb(52, 152, 219),
                ForeColor = Color.White,
                FlatStyle = FlatStyle.Flat,
                Font = new Font("Segoe UI", 12F, FontStyle.Bold)
            };
            btnEdit.FlatAppearance.BorderSize = 0;
            btnEdit.Click += BtnEdit_Click;

            // Delete Button
            btnDelete = new Button
            {
                Location = new Point(600, 15),
                Size = new Size(120, 40),
                Text = "üóëÔ∏è ÿ≠ÿ∞ŸÅ",
                BackColor = Color.FromArgb(231, 76, 60),
                ForeColor = Color.White,
                FlatStyle = FlatStyle.Flat,
                Font = new Font("Segoe UI", 12F, FontStyle.Bold)
            };
            btnDelete.FlatAppearance.BorderSize = 0;
            btnDelete.Click += BtnDelete_Click;

            // Only show delete button to Admin
            if (!SessionManager.IsAdmin)
            {
                btnDelete.Visible = false;
            }

            pnlActions.Controls.AddRange(new Control[] { btnAdd, btnEdit, btnDelete });

            // Add all to form
            this.Controls.Add(dgvProducts);
            this.Controls.Add(pnlSearch);
            this.Controls.Add(pnlActions);
            
            this.ResumeLayout(false);
        }

        private void SetupForm()
        {
            // Setup DataGridView columns
            dgvProducts.Columns.Clear();
            dgvProducts.Columns.Add("Id", "ÿßŸÑÿ±ŸÇŸÖ");
            dgvProducts.Columns.Add("Barcode", "ÿßŸÑÿ®ÿßÿ±ŸÉŸàÿØ");
            dgvProducts.Columns.Add("ProductNameArabic", "ÿßŸÑÿßÿ≥ŸÖ ÿ®ÿßŸÑÿπÿ±ÿ®Ÿäÿ©");
            dgvProducts.Columns.Add("ProductName", "ÿßŸÑÿßÿ≥ŸÖ ÿ®ÿßŸÑÿ•ŸÜÿ¨ŸÑŸäÿ≤Ÿäÿ©");
            dgvProducts.Columns.Add("CategoryName", "ÿßŸÑŸÅÿ¶ÿ©");
            dgvProducts.Columns.Add("CurrentStock", "ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ ÿßŸÑÿ≠ÿßŸÑŸä");
            dgvProducts.Columns.Add("MinimumStock", "ÿ≠ÿØ ÿ•ÿπÿßÿØÿ© ÿßŸÑÿ∑ŸÑÿ®");
            dgvProducts.Columns.Add("PurchasePrice", "ÿ≥ÿπÿ± ÿßŸÑÿ¥ÿ±ÿßÿ°");
            dgvProducts.Columns.Add("SalePrice", "ÿ≥ÿπÿ± ÿßŸÑÿ®Ÿäÿπ");
            dgvProducts.Columns.Add("ProfitPercentage", "ŸáÿßŸÖÿ¥ ÿßŸÑÿ±ÿ®ÿ≠ %");

            // Set column widths
            dgvProducts.Columns["Id"].Width = 60;
            dgvProducts.Columns["Barcode"].Width = 120;
            dgvProducts.Columns["ProductNameArabic"].Width = 200;
            dgvProducts.Columns["ProductName"].Width = 180;
            dgvProducts.Columns["CategoryName"].Width = 120;
            dgvProducts.Columns["CurrentStock"].Width = 80;
            dgvProducts.Columns["MinimumStock"].Width = 100;
            dgvProducts.Columns["PurchasePrice"].Width = 100;
            dgvProducts.Columns["SalePrice"].Width = 100;
            dgvProducts.Columns["ProfitPercentage"].Width = 100;

            // Center align numeric columns
            foreach (var col in new[] { "CurrentStock", "MinimumStock", "PurchasePrice", "SalePrice", "ProfitPercentage" })
            {
                dgvProducts.Columns[col].DefaultCellStyle.Alignment = DataGridViewContentAlignment.MiddleCenter;
            }
        }

        private void LoadCategories()
        {
            cmbCategory.Items.Clear();
            cmbCategory.Items.Add(new { Id = 0, NameArabic = "ÿ¨ŸÖŸäÿπ ÿßŸÑŸÅÿ¶ÿßÿ™" });
            
            var categories = _categoryRepository.GetAllCategories();
            foreach (var category in categories)
            {
                cmbCategory.Items.Add(category);
            }
            
            cmbCategory.DisplayMember = "NameArabic";
            cmbCategory.ValueMember = "Id";
            cmbCategory.SelectedIndex = 0;
        }

        private void LoadProducts()
        {
            try
            {
                var products = _productRepository.GetAllProducts();

                // Apply search filter
                if (!string.IsNullOrWhiteSpace(txtSearch.Text))
                {
                    var searchTerm = txtSearch.Text.Trim().ToLower();
                    products = products.Where(p =>
                        (p.ProductNameArabic != null && p.ProductNameArabic.ToLower().Contains(searchTerm)) ||
                        p.ProductName.ToLower().Contains(searchTerm) ||
                        (p.Barcode != null && p.Barcode.Contains(searchTerm))
                    ).ToList();
                }

                // Apply category filter
                if (cmbCategory.SelectedIndex > 0)
                {
                    var selectedCategory = (Category)cmbCategory.SelectedItem!;
                    products = products.Where(p => p.CategoryId == selectedCategory.Id).ToList();
                }

                // Apply low stock filter
                if (chkLowStock.Checked)
                {
                    products = products.Where(p => p.IsLowStock).ToList();
                }

                // Populate DataGridView
                dgvProducts.Rows.Clear();
                foreach (var product in products)
                {
                    var categoryName = _categoryRepository.GetCategoryById(product.CategoryId)?.NameArabic ?? "ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ";
                    
                    dgvProducts.Rows.Add(
                        product.Id,
                        product.Barcode ?? "N/A",
                        product.ProductNameArabic ?? product.ProductName,
                        product.ProductName,
                        categoryName,
                        product.CurrentStock,
                        product.MinimumStock,
                        product.PurchasePrice.ToString("F2"),
                        product.SalePrice.ToString("F2"),
                        product.ProfitPercentage.ToString("F1")
                    );
                }

                // Update stats
                lblTotalProducts.Text = $"ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™: {products.Count}";
                var lowStockCount = _productRepository.GetLowStockProducts().Count;
                lblLowStock.Text = $"ŸÖŸÜÿ™ÿ¨ÿßÿ™ ŸÇŸÑŸäŸÑÿ© ÿßŸÑŸÖÿÆÿ≤ŸàŸÜ: {lowStockCount}";
                lblLowStock.ForeColor = lowStockCount > 0 ? Color.Red : Color.Green;
            }
            catch (Exception ex)
            {
                MessageBox.Show($"ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™: {ex.Message}", "ÿÆÿ∑ÿ£",
                    MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
        }

        private void DgvProducts_CellFormatting(object? sender, DataGridViewCellFormattingEventArgs e)
        {
            if (dgvProducts.Columns[e.ColumnIndex].Name == "CurrentStock")
            {
                if (e.RowIndex >= 0 && e.Value != null)
                {
                    var quantity = int.Parse(e.Value.ToString()!);
                    var reorderLevel = int.Parse(dgvProducts.Rows[e.RowIndex].Cells["MinimumStock"].Value.ToString()!);
                    
                    if (quantity <= reorderLevel)
                    {
                        e.CellStyle.BackColor = Color.FromArgb(255, 220, 220);
                        e.CellStyle.ForeColor = Color.Red;
                        e.CellStyle.Font = new Font(e.CellStyle.Font!, FontStyle.Bold);
                    }
                }
            }
        }

        private void DgvProducts_CellDoubleClick(object? sender, DataGridViewCellEventArgs e)
        {
            if (e.RowIndex >= 0)
            {
                BtnEdit_Click(sender, e);
            }
        }

        private void BtnAdd_Click(object? sender, EventArgs e)
        {
            using var form = new ProductEditForm(_productRepository, _categoryRepository);
            if (form.ShowDialog() == DialogResult.OK)
            {
                LoadProducts();
            }
        }

        private void BtnEdit_Click(object? sender, EventArgs e)
        {
            if (dgvProducts.SelectedRows.Count == 0)
            {
                MessageBox.Show("Ÿäÿ±ÿ¨Ÿâ ÿßÿÆÿ™Ÿäÿßÿ± ŸÖŸÜÿ™ÿ¨ ŸÑŸÑÿ™ÿπÿØŸäŸÑ", "ÿ™ŸÜÿ®ŸäŸá",
                    MessageBoxButtons.OK, MessageBoxIcon.Warning);
                return;
            }

            var productId = (int)dgvProducts.SelectedRows[0].Cells["Id"].Value;
            var product = _productRepository.GetProductById(productId);

            if (product == null)
            {
                MessageBox.Show("ÿßŸÑŸÖŸÜÿ™ÿ¨ ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØ", "ÿÆÿ∑ÿ£",
                    MessageBoxButtons.OK, MessageBoxIcon.Error);
                return;
            }

            using var form = new ProductEditForm(_productRepository, _categoryRepository, product);
            if (form.ShowDialog() == DialogResult.OK)
            {
                LoadProducts();
            }
        }

        private void BtnDelete_Click(object? sender, EventArgs e)
        {
            if (dgvProducts.SelectedRows.Count == 0)
            {
                MessageBox.Show("Ÿäÿ±ÿ¨Ÿâ ÿßÿÆÿ™Ÿäÿßÿ± ŸÖŸÜÿ™ÿ¨ ŸÑŸÑÿ≠ÿ∞ŸÅ", "ÿ™ŸÜÿ®ŸäŸá",
                    MessageBoxButtons.OK, MessageBoxIcon.Warning);
                return;
            }

            var productId = (int)dgvProducts.SelectedRows[0].Cells["Id"].Value;
            var productName = dgvProducts.SelectedRows[0].Cells["ProductNameArabic"].Value?.ToString() 
                ?? dgvProducts.SelectedRows[0].Cells["ProductName"].Value?.ToString() 
                ?? "Unknown";

            var result = MessageBox.Show(
                $"ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖŸÜÿ™ÿ¨: {productName}ÿü\n\nŸÖŸÑÿßÿ≠ÿ∏ÿ©: ÿ≥Ÿäÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖŸÜÿ™ÿ¨ ŸÜŸáÿßÿ¶ŸäÿßŸã ŸàŸÑÿß ŸäŸÖŸÉŸÜ ÿßŸÑÿ™ÿ±ÿßÿ¨ÿπ ÿπŸÜ Ÿáÿ∞ÿß ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°.",
                "ÿ™ÿ£ŸÉŸäÿØ ÿßŸÑÿ≠ÿ∞ŸÅ",
                MessageBoxButtons.YesNo,
                MessageBoxIcon.Warning
            );

            if (result == DialogResult.Yes)
            {
                try
                {
                    _productRepository.DeleteProduct(productId);
                    MessageBox.Show("ÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖŸÜÿ™ÿ¨ ÿ®ŸÜÿ¨ÿßÿ≠", "ŸÜÿ¨ÿ≠",
                        MessageBoxButtons.OK, MessageBoxIcon.Information);
                    LoadProducts();
                }
                catch (Exception ex)
                {
                    MessageBox.Show($"ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖŸÜÿ™ÿ¨: {ex.Message}", "ÿÆÿ∑ÿ£",
                        MessageBoxButtons.OK, MessageBoxIcon.Error);
                }
            }
        }
    }
}
